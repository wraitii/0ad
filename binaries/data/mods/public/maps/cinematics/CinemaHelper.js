var cmpTrigger = Engine.QueryInterface(SYSTEM_ENTITY, IID_Trigger);

var SetupNodes = function(nodes)
{
	const targets = [];
	const positions = [];
	for (const node of nodes)
	{
		const pos = new Vector3D(node[1].x, node[1].y, node[1].z);
		const target = new Vector3D(node[2].x, node[2].y, node[2].z);
		targets.push({
			"deltaTime": node[0],
			"position": target,
		});
		positions.push({
			"deltaTime": node[0],
			"position": pos,
		});
	}
	return {
		"targetNodes": targets,
		"positionNodes": positions
	};
};

var SetupCinematics = function()
{
	const cmpRangeManager = Engine.QueryInterface(SYSTEM_ENTITY, IID_RangeManager);
	cmpRangeManager.SetLosRevealAll(-1, true);
};

var Cutscene = function(nodes)
{
	SetupCinematics();
	const cmpCinemaManager = Engine.QueryInterface(SYSTEM_ENTITY, IID_CinemaManager);
	if (!cmpCinemaManager)
		return;

	cmpCinemaManager.AddPath(Object.assign(
		{
			"name": "path",
			"orientation": "target",
		},
		SetupNodes(nodes)
	));
	cmpCinemaManager.AddCinemaPathToQueue("path");
	cmpCinemaManager.Play();
};


var SweepingCutscene = function()
{
	return [
		[0, { "z": 952.2245483398438, "y": 162.2513427734375, "x": 978.9868774414062 }, { "z": -0.6833544969558716, "y": -0.5144144892692566, "x": -0.518077552318573 }],
		[3, { "z": 935.9642333984375, "y": 145.8859405517578, "x": 700.643310546875 }, { "z": -0.820662260055542, "y": -0.5144144892692566, "x": -0.24877941608428955 }],
		[3, { "z": 714.6177978515625, "y": 154.90171813964844, "x": 220.47262573242188 }, { "z": -0.5084906816482544, "y": -0.4847635328769684, "x": 0.7116470336914062 }],
		[3, { "z": 22.481937408447266, "y": 307.2760009765625, "x": 180.7207489013672 }, { "z": 0.636842668056488, "y": -0.6195410490036011, "x": 0.45891207456588745 }],
		[3, { "z": 5.273491382598877, "y": 309.7719421386719, "x": 898.6748046875 }, { "z": 0.5955502986907959, "y": -0.5458177924156189, "x": -0.5894088745117188 }],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
};

var CircleAndZoomOut = function()
{
	return [
		[0, { "z": 549.6591796875, "y": 292.5040588378906, "x": 1068.151611328125 }, { "z": -0.02293475903570652, "y": -0.5735764503479004, "x": -0.8188309073448181 }],
		[3, { "z": 144.80787658691406, "y": 292.50408935546875, "x": 936.2776489257812 }, { "z": 0.5375285148620605, "y": -0.5735764503479004, "x": -0.6181207299232483 }],
		[3, { "z": -44.683570861816406, "y": 310.8581848144531, "x": 399.8305358886719 }, { "z": 0.7933655977249146, "y": -0.5735764503479004, "x": 0.20391440391540527 }],
		[3, { "z": 549.28076171875, "y": 255.89651489257812, "x": 64.36898040771484 }, { "z": -0.14571207761764526, "y": -0.5735764503479004, "x": 0.8060881495475769 }],
		[4, { "z": 1054.8958740234375, "y": 582.2236938476562, "x": 337.3681335449219 }, { "z": -0.6032422184944153, "y": -0.7788953185081482, "x": 0.17152516543865204 }],
		[5, { "z": 1205.614990234375, "y": 1030.8682861328125, "x": 1053.8759765625 }, { "z": -0.5014714002609253, "y": -0.7788953185081482, "x": -0.37662771344184875 }],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
};

var Circle2 = function()
{
	return [
[3, {"z":270.6487121582031,"y":276.1913146972656,"x":1062.5865478515625},{"z":0.3263511657714844,"y":-0.5735764503479004,"x":-0.7513354420661926}],
[3, {"z":57.32561492919922,"y":257.841552734375,"x":730.3180541992188},{"z":0.7264678478240967,"y":-0.5735764503479004,"x":-0.3784898817539215}],
[3, {"z":72.51422119140625,"y":221.14190673828125,"x":389.6005859375},{"z":0.8176444172859192,"y":-0.5735764503479004,"x":0.04967556521296501}],
[3, {"z":395.9656677246094,"y":221.14183044433594,"x":400.3293151855469},{"z":0.2707047760486603,"y":-0.5735764503479004,"x":-0.7731293439865112}],
[3, {"z":925.607666015625,"y":221.14183044433594,"x":193.23963928222656},{"z":-0.5537435412406921,"y":-0.5735764503479004,"x":0.6036374568939209}],
[3, {"z":1044.1455078125,"y":236.34323120117188,"x":691.6046752929688},{"z":-0.8061853647232056,"y":-0.5654356479644775,"x":-0.17420601844787598}],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
};

var LowPassSweep = function(speed = 0.5)
{
	return[
		[0, { "z": -112.52078247070312, "y": 215.32470703125, "x": 677.6026611328125 }, { "z": 0.8205944895744324, "y": -0.55849689245224, "x": -0.12126806378364563 }],
		[3 * speed, { "z": 121.81014251708984, "y": 215.32469177246094, "x": 731.4617309570312 }, { "z": 0.829461932182312, "y": -0.55849689245224, "x": 0.008612962439656258 }],
		[3 * speed, { "z": 439.1277770996094, "y": 215.3246307373047, "x": 870.178466796875 }, { "z": 0.6441696882247925, "y": -0.55849689245224, "x": -0.5226152539253235 }],
		[3 * speed, { "z": 871.84716796875, "y": 215.32456970214844, "x": 668.8464965820312 }, { "z": 0.5813797116279602, "y": -0.55849689245224, "x": 0.5916746854782104 }],
		[3 * speed, { "z": 1220.6146240234375, "y": 161.7267608642578, "x": 813.367919921875 }, { "z": 0.8185322880744934, "y": -0.55849689245224, "x": 0.13448473811149597 }],
		[3 * speed, { "z": 1522.921630859375, "y": 161.7267608642578, "x": 885.3181762695312 }, { "z": 0.8185322880744934, "y": -0.55849689245224, "x": 0.13448473811149597 }],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
};

var MiletusSweep = function()
{
	return [
		[0, {"z":781.8211059570312,"y":78.72954559326172,"x":1190.832275390625},{"z":-0.7377272248268127,"y":-0.6614888310432434,"x":0.13487467169761658}],
		[4, {"z":559.3838500976562,"y":78.72954559326172,"x":1128.441162109375},{"z":-0.7377272248268127,"y":-0.6614888310432434,"x":0.13487467169761658}],
		[4, {"z":443.5692443847656,"y":119.28892517089844,"x":1045.6343994140625},{"z":-0.7034203410148621,"y":-0.6476926207542419,"x":-0.2927355468273163}],
		[4, {"z":237.00685119628906,"y":160.86265563964844,"x":962.5526123046875},{"z":-0.12203467637300491,"y":-0.6476926207542419,"x":-0.7520650625228882}],
		[4, {"z":96.713134765625,"y":246.22860717773438,"x":792.607666015625},{"z":0.3660631477832794,"y":-0.7309521436691284,"x":-0.5759398341178894}],
		[4, {"z":148.93936157226562,"y":138.2056884765625,"x":420.6634521484375},{"z":0.561675488948822,"y":-0.5246853232383728,"x":0.6397076845169067}],
		[4, {"z":492.3199462890625,"y":205.28387451171875,"x":212.7586212158203},{"z":-0.12978000938892365,"y":-0.5246853232383728,"x":0.8413456678390503}],
		[4, {"z":1014.8984985351562,"y":255.66140747070312,"x":305.95037841796875},{"z":-0.742317259311676,"y":-0.5246853232383728,"x":0.416737824678421}],
		[4, {"z":1464.1942138671875,"y":339.59918212890625,"x":450.0216369628906},{"z":-0.8251499533653259,"y":-0.5246853232383728,"x":0.20936301350593567}],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
}
/**
 * Get coordinates with `warn(JSON.stringify(Engine.GetTerrainAtScreenPoint(mouseX, mouseY)));` in the console.
 */
var CirclePoint = function(x, y, z, distance=100.0, height = 100.0, speed = 0.5)
{
	const nodes = [];
	for (let i = 0; i <= 8; ++i)
	{
		const cos = Math.cos(i/4 * Math.PI);
		const sin = Math.sin(i/4 * Math.PI);
		nodes.push([i === 0 ? 0 : 3, {
			"x": x + cos * distance,
			"y": y + height,
			"z": z + sin * distance,
		},
		{
			"x": x, "y": y, "z": z
		}]);
	}
	return nodes;
};

/**
 * Get start/end coordinates with `warn(JSON.stringify(Engine.GetTerrainAtScreenPoint(mouseX, mouseY)));`.
 * Get camera coordinates with `warn(JSON.stringify([Engine.GetCameraPosition(), Engine.GetCameraRotation()]))`
 */
var Travelling = function(cameraStart, cameraEnd, start, end)
{
	start = new Vector3D(start.x, start.y, start.z);
	end = new Vector3D(end.x, end.y, end.z);
	cameraStart = new Vector3D(cameraStart.x, cameraStart.y, cameraStart.z);
	cameraEnd = new Vector3D(cameraEnd.x, cameraEnd.y, cameraEnd.z);

	const vec = Vector3D.sub(end, start).mult(0.2);
	const cvec = Vector3D.sub(cameraEnd, cameraStart).mult(0.2);
	return [
		[0, Vector3D.sub(cameraStart, cvec), Vector3D.sub(start, vec)],
		[2, cameraStart, start],
		[7, cameraEnd, end],
		[9, Vector3D.add(cameraEnd, cvec), Vector3D.add(end, vec)],
	];
};

var SheepVideo = function()
{
	return [
		[-3, {"z":1221.10791015625,"y":98.03709411621094,"x":776.4122314453125},{"z":-0.5085267424583435,"y":-0.4702669084072113,"x":-0.7212833166122437}],
		[3, {"z":1147.385009765625,"y":117.99891662597656,"x":736.833251953125},{"z":-0.18009012937545776,"y":-0.6027061343193054,"x":-0.7773756980895996}],
		[6, {"z":1030.09033203125,"y":135.5229034423828,"x":729.2747802734375},{"z":0.5244688391685486,"y":-0.6027061343193054,"x":-0.6013965606689453}],
		[12, {"z":798.718994140625,"y":232.4162139892578,"x":645.72216796875},{"z":0.8354641795158386,"y":-0.5479750037193298,"x":-0.04150788113474846}],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
};

var Croco = function()
{
	return [
[ 0, {"z":400,"y":113.28958892822266,"x":181.89434814453125},{"z":0.7450998425483704,"y":-0.49153631925582886,"x":0.45079734921455383}],
[ 35, {"z":372.41339111328125,"y":113.28958892822266,"x":181.89434814453125},{"z":0.7450998425483704,"y":-0.49153631925582886,"x":0.45079734921455383}],
[ 8, {"z":293.4562683105469,"y":67.50772857666016,"x":135.83969116210938},{"z":0.7570740580558777,"y":-0.2937043607234955,"x":0.5835894346237183}],
[ 4, {"z":528.7643432617188,"y":48.75044250488281,"x":264.66973876953125},{"z":0.8401687145233154,"y":-0.2937043607234955,"x":0.45591041445732117}],
[ 3, {"z":674.5556030273438,"y":39.3586540222168,"x":306.9540710449219},{"z":0.6703080534934998,"y":-0.2937043607234955,"x":0.6814872622489929}],
[ 3, {"z":704.861083984375,"y":39.35865783691406,"x":420.5868225097656},{"z":0.917681872844696,"y":-0.2937043607234955,"x":0.26757755875587463}],
[ 3, {"z":696.4364013671875,"y":86.93028259277344,"x":556.3152465820312},{"z":0.6251937747001648,"y":-0.5341529250144958,"x":-0.5690460801124573}],
[ 4, {"z":928.5547485351562,"y":121.11668395996094,"x":680.943115234375},{"z":-0.46365004777908325,"y":-0.5341529250144958,"x":-0.7069011926651001}],
[ 3, {"z":885.0640258789062,"y":121.11668395996094,"x":385.95770263671875},{"z":-0.40108436346054077,"y":-0.5341529250144958,"x":0.7441854476928711}],
[ 3, {"z":727.73876953125,"y":70.24422454833984,"x":488.0421447753906},{"z":0.04931872710585594,"y":-0.3527924418449402,"x":0.9344009757041931}],
[ 8, {"z":645.6234741210938,"y":75.24421691894531,"x":560.43994140625},{"z":0.4235682785511017,"y":-0.3527924418449402,"x":0.8343424797058105}],
	].map(x => {
		x[2] = Vector3D.add(x[1], Vector3D.mult(x[2], 100));
		return x;
	});
}

Trigger.prototype.StartCutscene = function()
{
	if (InitAttributes.map === "maps/skirmishes/syria_2p")
		Cutscene(SheepVideo());
	else if (InitAttributes.map === "maps/skirmishes/miletus_peninsula_2p")
		Cutscene(MiletusSweep());
	else if (InitAttributes.map === "maps/skirmishes/crocodilopolis_4p")
		Cutscene(Croco());
	else
		Cutscene(
			pickRandom([
				SweepingCutscene(),
				CircleAndZoomOut(),
				Circle2(),
				LowPassSweep(),
				CirclePoint(randFloat(150, 350), 23, randFloat(150, 350), 250, 150.0),
			])
		);
	/* Travelling(
		{ "z": 100, "y": 115, " x": 602 },
		{ "z": 447, "y": 64, "x": 574 },
		{ "x": 603, "y": 20, "z": 251 },
		{ "x": 636, "y": 25, "z": 522 }
	)/* */
};

{
	const cmpTrigger = Engine.QueryInterface(SYSTEM_ENTITY, IID_Trigger);
	cmpTrigger.RegisterTrigger("OnInitGame", "StartCutscene", { "enabled": true });
	//cmpTrigger.StartCutscene();
}
